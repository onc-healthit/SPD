import unittest
from random import randint, randrange

from nppes_data_generators.npis.config import LOWER_LIMIT, UPPER_LIMIT
from nppes_data_generators.npis.npi import luhn_digit_generator, calculate_check_digit, npi, npi_generator
from nppes_data_generators.npis.utils import backward_digit_generator, double_to_digit, append_digit


class TestNPIGenerator(unittest.TestCase):

    def test_backward_digit_generator(self):
        numbers = (randrange(LOWER_LIMIT, UPPER_LIMIT) for _ in range(randint(10, 100)))
        for n in numbers:
            expected = list(reversed([int(_) for _ in str(n)]))
            computed = list(backward_digit_generator(n))
            self.assertListEqual(expected, computed, '%s vs %s' % (str(expected), str(computed)))

    def test_double_to_digit(self):
        numbers = (randint(0, 100) for _ in range(randint(10, 100)))
        for n in numbers:
            self.assertRaises(AssertionError) if n > 18 else \
                self.assertEqual(n * 2 - (9 if n >= 5 else 0),
                                 double_to_digit(n),
                                 "Failed for %i" % n)

    def test_luhn_digit_generator(self):
        numbers = [101010101, 111111111, 222222222, 555555555, 999999999, 123456789]
        expected = [[2, 0, 2, 0, 2, 0, 2, 0, 2], [2, 1, 2, 1, 2, 1, 2, 1, 2],
                    [4, 2, 4, 2, 4, 2, 4, 2, 4], [1, 5, 1, 5, 1, 5, 1, 5, 1],
                    [9, 9, 9, 9, 9, 9, 9, 9, 9], [9, 8, 5, 6, 1, 4, 6, 2, 2]]
        computed = [list(luhn_digit_generator(_)) for _ in numbers]
        self.assertListEqual(expected, computed, "%s vs %s" % (str(expected), str(computed)))

    def test_calculate_check_digit(self):
        numbers = [22, 54, 18, 36, 80, 67, 29, 65, 71, 93]
        expected = [8, 6, 2, 4, 0, 3, 1, 5, 9, 7]
        computed = [calculate_check_digit(_) for _ in numbers]
        self.assertListEqual(expected, computed, "%s vs %s" % (str(expected), str(computed)))

    def test_append_digit(self):
        numbers = [randrange(LOWER_LIMIT, UPPER_LIMIT) for _ in range(randint(10, 100))]
        expected = list(map(lambda _: _[1] * 10 + _[0], enumerate(numbers)))
        computed = list(map(append_digit, numbers, range(len(numbers))))
        self.assertListEqual(expected, computed, "%s vs %s" % (str(expected), str(computed)))

    def test_npi(self):
        numbers = [526099177, 803868156, 661888417, 469207612, 940171461, 476079258, 711739480, 578171390, 459191466,
                   701160661, 725987492, 465074378, 377439506, 399668706, 391690382, 467638221, 719844374, 427463128,
                   401338489, 729990968, 690821879, 751338998, 450449884, 597066944, 899200931, 902955256, 516461292,
                   994679774, 942550851, 717168871, 348472690, 593704391, 679572027, 474631286, 464841466, 531889211,
                   853421204, 624293147, 389208142, 429983274, 441974097, 475453781, 626929147, 485016529, 539554412,
                   947986730, 324531426, 459182996, 361709323, 817197121, 871958480, 599957671, 673409252, 535634782,
                   325584886, 420030504, 855657626, 645415907]
        check_digits = [8, 4, 8, 6, 0, 8, 0, 9, 6, 4, 4, 2, 5, 7, 6, 9, 0, 0, 4, 0, 8, 2, 9, 1, 5, 6, 6, 0, 9, 7, 6, 2,
                        8, 5, 0, 9, 7, 8, 3, 9, 0, 7, 5, 9, 0, 8, 5, 3, 2, 0, 6, 8, 4, 8, 3, 1, 1, 3]
        expected = list(map(lambda n, d: n * 10 + d, numbers, check_digits))
        computed = [npi(_) for _ in numbers]
        self.assertListEqual(expected, computed, "%s vs %s" % (str(expected), str(computed)))

    def test_backward_npi_generator(self):
        expected = [5456785364, 5456785356, 5456785349, 5456785331, 5456785323, 5456785315, 5456785307, 5456785299,
                    5456785281, 5456785273, 5456785265, 5456785257, 5456785240, 5456785232, 5456785224, 5456785216,
                    5456785208, 5456785190, 5456785182, 5456785174, 5456785166, 5456785158, 5456785141, 5456785133,
                    5456785125, 5456785117, 5456785109, 5456785091, 5456785083, 5456785075, 5456785067, 5456785059,
                    5456785042, 5456785034, 5456785026, 5456785018, 5456785000, 5456784995, 5456784987, 5456784979,
                    5456784961, 5456784953, 5456784946, 5456784938, 5456784920, 5456784912, 5456784904, 5456784896,
                    5456784888, 5456784870, 5456784862, 5456784854, 5456784847, 5456784839, 5456784821, 5456784813,
                    5456784805, 5456784797, 5456784789, 5456784771, 5456784763, 5456784755, 5456784748, 5456784730,
                    5456784722, 5456784714, 5456784706, 5456784698, 5456784680, 5456784672, 5456784664, 5456784656,
                    5456784649, 5456784631, 5456784623, 5456784615, 5456784607, 5456784599, 5456784581, 5456784573,
                    5456784565, 5456784557, 5456784540, 5456784532, 5456784524, 5456784516, 5456784508, 5456784490,
                    5456784482, 5456784474, 5456784466, 5456784458, 5456784441, 5456784433, 5456784425, 5456784417,
                    5456784409, 5456784391, 5456784383, 5456784375, 5456784367, 5456784359, 5456784342, 5456784334,
                    5456784326, 5456784318, 5456784300, 5456784292, 5456784284, 5456784276, 5456784268, 5456784250,
                    5456784243, 5456784235, 5456784227, 5456784219, 5456784201, 5456784193, 5456784185, 5456784177,
                    5456784169, 5456784151, 5456784144, 5456784136, 5456784128, 5456784110, 5456784102, 5456784094,
                    5456784086, 5456784078, 5456784060, 5456784052, 5456784045, 5456784037, 5456784029, 5456784011,
                    5456784003, 5456783997, 5456783989, 5456783971, 5456783963, 5456783955, 5456783948, 5456783930,
                    5456783922, 5456783914, 5456783906, 5456783898, 5456783880, 5456783872, 5456783864, 5456783856,
                    5456783849, 5456783831, 5456783823, 5456783815, 5456783807, 5456783799, 5456783781, 5456783773,
                    5456783765, 5456783757, 5456783740, 5456783732, 5456783724, 5456783716, 5456783708, 5456783690,
                    5456783682, 5456783674, 5456783666, 5456783658, 5456783641, 5456783633, 5456783625, 5456783617,
                    5456783609, 5456783591, 5456783583, 5456783575, 5456783567, 5456783559, 5456783542, 5456783534,
                    5456783526, 5456783518, 5456783500, 5456783492, 5456783484, 5456783476, 5456783468, 5456783450,
                    5456783443, 5456783435, 5456783427, 5456783419, 5456783401, 5456783393, 5456783385, 5456783377,
                    5456783369, 5456783351, 5456783344, 5456783336, 5456783328, 5456783310, 5456783302, 5456783294,
                    5456783286, 5456783278, 5456783260, 5456783252, 5456783245, 5456783237, 5456783229, 5456783211,
                    5456783203, 5456783195, 5456783187, 5456783179, 5456783161, 5456783153, 5456783146, 5456783138,
                    5456783120, 5456783112, 5456783104, 5456783096, 5456783088, 5456783070, 5456783062, 5456783054,
                    5456783047, 5456783039, 5456783021, 5456783013, 5456783005, 5456782999, 5456782981, 5456782973,
                    5456782965, 5456782957, 5456782940, 5456782932, 5456782924, 5456782916, 5456782908, 5456782890,
                    5456782882, 5456782874, 5456782866, 5456782858, 5456782841, 5456782833, 5456782825, 5456782817,
                    5456782809, 5456782791, 5456782783, 5456782775, 5456782767, 5456782759, 5456782742, 5456782734,
                    5456782726, 5456782718, 5456782700, 5456782692, 5456782684, 5456782676, 5456782668, 5456782650,
                    5456782643, 5456782635, 5456782627, 5456782619, 5456782601, 5456782593, 5456782585, 5456782577,
                    5456782569, 5456782551, 5456782544, 5456782536, 5456782528, 5456782510, 5456782502, 5456782494,
                    5456782486, 5456782478, 5456782460, 5456782452, 5456782445, 5456782437, 5456782429, 5456782411,
                    5456782403, 5456782395, 5456782387, 5456782379, 5456782361, 5456782353, 5456782346, 5456782338,
                    5456782320, 5456782312, 5456782304, 5456782296, 5456782288, 5456782270, 5456782262, 5456782254,
                    5456782247, 5456782239, 5456782221, 5456782213, 5456782205, 5456782197, 5456782189, 5456782171,
                    5456782163, 5456782155, 5456782148, 5456782130, 5456782122, 5456782114, 5456782106, 5456782098,
                    5456782080, 5456782072, 5456782064, 5456782056, 5456782049, 5456782031, 5456782023, 5456782015,
                    5456782007, 5456781991, 5456781983, 5456781975, 5456781967, 5456781959, 5456781942, 5456781934,
                    5456781926, 5456781918, 5456781900, 5456781892, 5456781884, 5456781876, 5456781868, 5456781850,
                    5456781843, 5456781835, 5456781827, 5456781819, 5456781801, 5456781793, 5456781785, 5456781777,
                    5456781769, 5456781751, 5456781744, 5456781736, 5456781728, 5456781710, 5456781702, 5456781694,
                    5456781686, 5456781678, 5456781660, 5456781652, 5456781645, 5456781637, 5456781629, 5456781611,
                    5456781603, 5456781595, 5456781587, 5456781579, 5456781561, 5456781553, 5456781546, 5456781538,
                    5456781520, 5456781512, 5456781504, 5456781496, 5456781488, 5456781470, 5456781462, 5456781454,
                    5456781447, 5456781439, 5456781421, 5456781413, 5456781405, 5456781397, 5456781389, 5456781371,
                    5456781363, 5456781355, 5456781348, 5456781330, 5456781322, 5456781314, 5456781306, 5456781298,
                    5456781280, 5456781272, 5456781264, 5456781256, 5456781249, 5456781231, 5456781223, 5456781215,
                    5456781207, 5456781199, 5456781181, 5456781173, 5456781165, 5456781157, 5456781140, 5456781132,
                    5456781124, 5456781116, 5456781108, 5456781090, 5456781082, 5456781074, 5456781066, 5456781058,
                    5456781041, 5456781033, 5456781025, 5456781017, 5456781009, 5456780993, 5456780985, 5456780977,
                    5456780969, 5456780951, 5456780944, 5456780936, 5456780928, 5456780910, 5456780902, 5456780894,
                    5456780886, 5456780878, 5456780860, 5456780852, 5456780845, 5456780837, 5456780829, 5456780811,
                    5456780803, 5456780795, 5456780787, 5456780779, 5456780761, 5456780753, 5456780746, 5456780738,
                    5456780720, 5456780712, 5456780704, 5456780696, 5456780688, 5456780670, 5456780662, 5456780654,
                    5456780647, 5456780639, 5456780621, 5456780613, 5456780605, 5456780597, 5456780589, 5456780571,
                    5456780563, 5456780555, 5456780548, 5456780530, 5456780522, 5456780514, 5456780506, 5456780498,
                    5456780480, 5456780472, 5456780464, 5456780456, 5456780449, 5456780431, 5456780423, 5456780415,
                    5456780407, 5456780399, 5456780381, 5456780373, 5456780365, 5456780357, 5456780340, 5456780332,
                    5456780324, 5456780316, 5456780308, 5456780290, 5456780282, 5456780274, 5456780266, 5456780258,
                    5456780241, 5456780233, 5456780225, 5456780217, 5456780209, 5456780191, 5456780183, 5456780175,
                    5456780167, 5456780159, 5456780142, 5456780134, 5456780126, 5456780118, 5456780100, 5456780092,
                    5456780084, 5456780076, 5456780068, 5456780050, 5456780043, 5456780035, 5456780027, 5456780019,
                    5456780001, 5456779995, 5456779987, 5456779979, 5456779961, 5456779953, 5456779946, 5456779938,
                    5456779920, 5456779912, 5456779904, 5456779896, 5456779888, 5456779870, 5456779862, 5456779854,
                    5456779847, 5456779839, 5456779821, 5456779813, 5456779805, 5456779797, 5456779789, 5456779771,
                    5456779763, 5456779755, 5456779748, 5456779730, 5456779722, 5456779714, 5456779706, 5456779698,
                    5456779680, 5456779672, 5456779664, 5456779656, 5456779649, 5456779631, 5456779623, 5456779615,
                    5456779607, 5456779599, 5456779581, 5456779573, 5456779565, 5456779557, 5456779540, 5456779532,
                    5456779524, 5456779516, 5456779508, 5456779490, 5456779482, 5456779474, 5456779466, 5456779458,
                    5456779441, 5456779433, 5456779425, 5456779417, 5456779409, 5456779391, 5456779383, 5456779375,
                    5456779367, 5456779359, 5456779342, 5456779334, 5456779326, 5456779318, 5456779300, 5456779292,
                    5456779284, 5456779276, 5456779268, 5456779250, 5456779243, 5456779235, 5456779227, 5456779219,
                    5456779201, 5456779193, 5456779185, 5456779177, 5456779169, 5456779151, 5456779144, 5456779136,
                    5456779128, 5456779110, 5456779102, 5456779094, 5456779086, 5456779078, 5456779060, 5456779052,
                    5456779045, 5456779037, 5456779029, 5456779011, 5456779003, 5456778997, 5456778989, 5456778971,
                    5456778963, 5456778955, 5456778948, 5456778930, 5456778922, 5456778914, 5456778906, 5456778898,
                    5456778880, 5456778872, 5456778864, 5456778856, 5456778849, 5456778831, 5456778823, 5456778815,
                    5456778807, 5456778799, 5456778781, 5456778773, 5456778765, 5456778757, 5456778740, 5456778732,
                    5456778724, 5456778716, 5456778708, 5456778690, 5456778682, 5456778674, 5456778666, 5456778658,
                    5456778641, 5456778633, 5456778625, 5456778617, 5456778609, 5456778591, 5456778583, 5456778575,
                    5456778567, 5456778559, 5456778542, 5456778534, 5456778526, 5456778518, 5456778500, 5456778492,
                    5456778484, 5456778476, 5456778468, 5456778450, 5456778443, 5456778435, 5456778427, 5456778419,
                    5456778401, 5456778393, 5456778385, 5456778377, 5456778369, 5456778351, 5456778344, 5456778336,
                    5456778328, 5456778310, 5456778302, 5456778294, 5456778286, 5456778278, 5456778260, 5456778252,
                    5456778245, 5456778237, 5456778229, 5456778211, 5456778203, 5456778195, 5456778187, 5456778179,
                    5456778161, 5456778153, 5456778146, 5456778138, 5456778120, 5456778112, 5456778104, 5456778096,
                    5456778088, 5456778070, 5456778062, 5456778054, 5456778047, 5456778039, 5456778021, 5456778013,
                    5456778005, 5456777999, 5456777981, 5456777973, 5456777965, 5456777957, 5456777940, 5456777932,
                    5456777924, 5456777916, 5456777908, 5456777890, 5456777882, 5456777874, 5456777866, 5456777858,
                    5456777841, 5456777833, 5456777825, 5456777817, 5456777809, 5456777791, 5456777783, 5456777775,
                    5456777767, 5456777759, 5456777742, 5456777734, 5456777726, 5456777718, 5456777700, 5456777692,
                    5456777684, 5456777676, 5456777668, 5456777650, 5456777643, 5456777635, 5456777627, 5456777619,
                    5456777601, 5456777593, 5456777585, 5456777577, 5456777569, 5456777551, 5456777544, 5456777536,
                    5456777528, 5456777510, 5456777502, 5456777494, 5456777486, 5456777478, 5456777460, 5456777452,
                    5456777445, 5456777437, 5456777429, 5456777411, 5456777403, 5456777395, 5456777387, 5456777379,
                    5456777361, 5456777353, 5456777346, 5456777338, 5456777320, 5456777312, 5456777304, 5456777296,
                    5456777288, 5456777270, 5456777262, 5456777254, 5456777247, 5456777239, 5456777221, 5456777213,
                    5456777205, 5456777197, 5456777189, 5456777171, 5456777163, 5456777155, 5456777148, 5456777130,
                    5456777122, 5456777114, 5456777106, 5456777098, 5456777080, 5456777072, 5456777064, 5456777056,
                    5456777049, 5456777031, 5456777023, 5456777015, 5456777007, 5456776991, 5456776983, 5456776975,
                    5456776967, 5456776959, 5456776942, 5456776934, 5456776926, 5456776918, 5456776900, 5456776892,
                    5456776884, 5456776876, 5456776868, 5456776850, 5456776843, 5456776835, 5456776827, 5456776819,
                    5456776801, 5456776793, 5456776785, 5456776777, 5456776769, 5456776751, 5456776744, 5456776736,
                    5456776728, 5456776710, 5456776702, 5456776694, 5456776686, 5456776678, 5456776660, 5456776652,
                    5456776645, 5456776637, 5456776629, 5456776611, 5456776603, 5456776595, 5456776587, 5456776579,
                    5456776561, 5456776553, 5456776546, 5456776538, 5456776520, 5456776512, 5456776504, 5456776496,
                    5456776488, 5456776470, 5456776462, 5456776454, 5456776447, 5456776439, 5456776421, 5456776413,
                    5456776405, 5456776397, 5456776389, 5456776371, 5456776363, 5456776355, 5456776348, 5456776330,
                    5456776322, 5456776314, 5456776306, 5456776298, 5456776280, 5456776272, 5456776264, 5456776256,
                    5456776249, 5456776231, 5456776223, 5456776215, 5456776207, 5456776199, 5456776181, 5456776173,
                    5456776165, 5456776157, 5456776140, 5456776132, 5456776124, 5456776116, 5456776108, 5456776090,
                    5456776082, 5456776074, 5456776066, 5456776058, 5456776041, 5456776033, 5456776025, 5456776017,
                    5456776009, 5456775993, 5456775985, 5456775977, 5456775969, 5456775951, 5456775944, 5456775936,
                    5456775928, 5456775910, 5456775902, 5456775894, 5456775886, 5456775878, 5456775860, 5456775852,
                    5456775845, 5456775837, 5456775829, 5456775811, 5456775803, 5456775795, 5456775787, 5456775779,
                    5456775761, 5456775753, 5456775746, 5456775738, 5456775720, 5456775712, 5456775704, 5456775696,
                    5456775688, 5456775670, 5456775662, 5456775654, 5456775647, 5456775639, 5456775621, 5456775613,
                    5456775605, 5456775597, 5456775589, 5456775571, 5456775563, 5456775555, 5456775548, 5456775530,
                    5456775522, 5456775514, 5456775506, 5456775498, 5456775480, 5456775472, 5456775464, 5456775456,
                    5456775449, 5456775431, 5456775423, 5456775415, 5456775407, 5456775399, 5456775381, 5456775373,
                    5456775365]
        computed = list(npi_generator(545678536, 545677535))
        self.assertListEqual(expected, computed, "%s vs %s" % (str(expected), str(computed)))
